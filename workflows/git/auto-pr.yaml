# Auto PR/MR with AI
# Automatically creates PR or MR with AI-generated title and description
name: git-auto-pr
description: Create PR/MR with AI-generated title and description
version: 1.0.0
author: hackflow

mcps_required:
  - shell
  - github

config_schema:
  provider:
    type: string
    description: Git provider (github or gitlab)
    required: true
  
  target_branch:
    type: string
    description: Target branch to merge into
    required: false
    default: "main"

prompt_mode: static

steps:
  # Step 1: Get current branch
  - action: shell.execute_command
    description: Get current branch
    params:
      command: "git rev-parse --abbrev-ref HEAD"
    output: current_branch

  # Step 2: Get remote URL to extract owner/repo
  - action: shell.execute_command
    description: Get remote URL
    params:
      command: "git remote get-url origin"
    output: remote_url

  # Step 3: Detect the actual default branch (main, master, etc.)
  # Use bash -c to ensure proper shell interpretation for pipes
  # refs/remotes/origin/master -> master
  - action: shell.execute_command
    description: Get default branch from remote
    params:
      command: "bash -c \"git symbolic-ref refs/remotes/origin/HEAD | sed 's|refs/remotes/origin/||'\""
    output: actual_target_branch

  # Step 4: Get all commits on this branch not in target
  - action: shell.execute_command
    description: Get commit log
    params:
      command: "git log --oneline origin/HEAD..HEAD"
    output: commit_log

  # Step 5: Get full diff from target branch
  - action: shell.execute_command
    description: Get diff from target
    params:
      command: "git diff origin/HEAD...HEAD --stat"
    output: diff_stat

  # Step 6: AI generates PR title
  - action: ai.generate
    description: Generate PR title
    params:
      prompt: |
        Create a pull request title for these changes:
        
        Branch: {{current_branch}}
        Target: {{actual_target_branch}}
        
        Commits:
        {{commit_log}}
        
        Rules:
        - Max 72 characters
        - Be specific and descriptive
        - No quotes around the title
        
        Return ONLY the title text, nothing else.
      temperature: 0.3
      max_tokens: 50
    output: pr_title

  # Step 7: AI generates PR description
  - action: ai.generate
    description: Generate PR description
    params:
      prompt: |
        Create a pull request description for these changes:
        
        Branch: {{current_branch}}
        Target: {{actual_target_branch}}
        
        Commits:
        {{commit_log}}
        
        Changed files:
        {{diff_stat}}
        
        Format with markdown:
        ## What Changed
        - bullet points
        
        ## Why
        Brief explanation
        
        Return ONLY the description, no preamble.
      temperature: 0.4
      max_tokens: 500
    output: pr_description

  # Step 8: Log generated details
  - action: log.info
    params:
      message: |
        
        ðŸ“ AI Generated PR/MR Details:
        
        Title: {{pr_title}}
        
        Description:
        {{pr_description}}
        
        Branch: {{current_branch}} â†’ {{actual_target_branch}}
        Provider: {{provider}}

  # Step 9: Extract owner/repo from remote URL
  # Format: git@github.com:owner/repo.git or https://github.com/owner/repo.git
  - action: ai.generate
    description: Extract owner and repo from remote URL
    params:
      prompt: |
        Extract the owner and repo from this git remote URL:
        {{remote_url}}
        
        Output ONLY in this exact format, nothing else:
        owner/repo
        
        Examples:
        - git@github.com:frostzt/hackflow.git -> frostzt/hackflow
        - https://github.com/frostzt/hackflow.git -> frostzt/hackflow
        - https://github.com/frostzt/hackflow -> frostzt/hackflow
      temperature: 0.1
      max_tokens: 50
    output: owner_repo

  # Step 10: Parse owner from owner_repo
  - action: shell.execute_command
    description: Extract owner from owner/repo
    params:
      command: "echo '{{owner_repo}}' | cut -d'/' -f1 | tr -d '\\n '"
    output: owner

  # Step 11: Parse repo from owner_repo
  - action: shell.execute_command
    description: Extract repo from owner/repo
    params:
      command: "echo '{{owner_repo}}' | cut -d'/' -f2 | tr -d '\\n '"
    output: repo

  # Step 12: Create the PR on GitHub
  - action: github.create_pull_request
    description: Create pull request on GitHub
    params:
      owner: "{{owner}}"
      repo: "{{repo}}"
      head: "{{current_branch}}"
      base: "{{actual_target_branch}}"
      title: "{{pr_title}}"
      body: "{{pr_description}}"
      draft: false
      maintainer_can_modify: true
    output: pr_result

  # Step 13: Show success message
  - action: log.info
    description: Show PR creation result
    params:
      message: |
        
        âœ… Pull Request Created!
        
        {{pr_result}}
        
        Branch: {{current_branch}} â†’ {{actual_target_branch}}
        Repository: {{owner}}/{{repo}}
