# GitHub Create PR (Non-Interactive)
# Creates a GitHub PR with provided parameters - no prompts
# If PR already exists, it will log the info and continue
name: github-create-pr
description: Create a GitHub pull request (non-interactive)
version: 1.0.0
author: hackflow

mcps_required:
  - github
  - shell

config_schema:
  owner:
    type: string
    description: Repository owner (username or organization)
    required: true
  
  repo:
    type: string
    description: Repository name
    required: true
  
  head:
    type: string
    description: Source branch (the branch with your changes)
    required: true
  
  base:
    type: string
    description: Target branch to merge into
    required: false
    default: "main"
  
  title:
    type: string
    description: Pull request title
    required: true
  
  body:
    type: string
    description: Pull request description
    required: false
    default: ""
  
  draft:
    type: boolean
    description: Create as draft PR
    required: false
    default: false

prompt_mode: static

steps:
  # Use gh CLI to check if PR exists (more reliable)
  - action: shell.execute_command
    description: Check for existing PR using gh CLI
    params:
      command: "gh pr list --repo {{owner}}/{{repo}} --head {{head}} --base {{base}} --state open --json url,number --limit 1"
    output: existing_pr_json

  # Check if we got a PR back (non-empty array means PR exists)
  - action: variable.set
    params:
      name: pr_exists
      value: false

  - action: variable.set
    params:
      name: pr_exists  
      value: true
    if: '{{existing_pr_json}} != "[]"'

  # If PR exists, just log it
  - action: log.info
    params:
      message: |
        
        â„¹ï¸  Pull Request Already Exists!
        
        ğŸ“‹ Branch: {{head}} â†’ {{base}}
        ğŸ“ Repo: {{owner}}/{{repo}}
        
        Existing PR info:
        {{existing_pr_json}}
        
        Your changes have been pushed to the existing PR.
    if: '{{pr_exists}} == true'

  # Create the pull request only if it doesn't exist
  - action: github.create_pull_request
    description: Create GitHub pull request
    params:
      owner: "{{owner}}"
      repo: "{{repo}}"
      head: "{{head}}"
      base: "{{base}}"
      title: "{{title}}"
      body: "{{body}}"
      draft: "{{draft}}"
      maintainer_can_modify: true
    output: pr_result
    if: '{{pr_exists}} == false'

  # Display result for new PR
  - action: log.info
    params:
      message: |
        
        âœ… Pull Request Created!
        
        ğŸ“‹ Title: {{title}}
        ğŸ”€ Branch: {{head}} â†’ {{base}}
        ğŸ“ Repo: {{owner}}/{{repo}}
        ğŸ”— URL: {{pr_result.url}}
    if: '{{pr_exists}} == false'

  # Set final URL for parent workflow
  - action: variable.set
    params:
      name: final_pr_url
      value: "{{pr_result.url}}"
    if: '{{pr_exists}} == false'

  - action: variable.set
    params:
      name: final_pr_url
      value: "See existing PR info above"
    if: '{{pr_exists}} == true'
