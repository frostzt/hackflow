# Auto Ship - Intelligent Git Workflow
# Analyzes changes, creates branch, commits in chunks, pushes, and creates PR/MR
# Minimal human intervention - AI does the heavy lifting!
name: auto-ship
description: Automatically ship your code changes with AI-powered commits and PR/MR
version: 1.0.0
author: hackflow

mcps_required:
  - shell
  - git
  - github
  - gitlab

config_schema:
  provider:
    type: string
    description: Git provider (github or gitlab)
    required: false
    default: "github"
  
  target_branch:
    type: string
    description: Target branch to merge into
    required: false
    default: "main"
  
  skip_branch_creation:
    type: boolean
    description: Skip branch creation (already on feature branch)
    required: false
    default: false
  
  github_owner:
    type: string
    description: GitHub repository owner (required for github provider)
    required: false
  
  github_repo:
    type: string
    description: GitHub repository name (required for github provider)
    required: false
  
  gitlab_project_id:
    type: string
    description: GitLab project ID (required for gitlab provider)
    required: false

prompt_mode: static

steps:
  # ============================================================================
  # PHASE 1: ANALYZE CHANGES
  # ============================================================================
  
  - action: log.info
    params:
      message: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘              ğŸš€ AUTO-SHIP INITIATED                       â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Phase 1: Analyzing your changes with AI...

  - action: workflow.run
    description: Analyze changes with AI
    params:
      workflow: "git-analyze-changes"
    output: analysis_result

  # Extract analysis from result
  - action: variable.set
    params:
      name: branch_name
      value: "{{analysis_result.suggested_branch}}"

  - action: variable.set
    params:
      name: change_summary
      value: "{{analysis_result.change_summary}}"

  - action: variable.set
    params:
      name: change_type
      value: "{{analysis_result.change_type}}"

  # ============================================================================
  # PHASE 2: CREATE BRANCH (with smart detection)
  # ============================================================================
  
  # Get current branch to check if we need to create a new one
  - action: shell.execute_command
    description: Get current branch
    params:
      command: "git rev-parse --abbrev-ref HEAD"
    output: current_branch

  # Determine if we should skip branch creation:
  # - User explicitly requested skip OR
  # - Already on a feature/fix/etc branch (not main/master/develop)
  - action: variable.set
    params:
      name: should_create_branch
      value: true

  # Skip if user requested
  - action: variable.set
    params:
      name: should_create_branch
      value: false
    if: '{{skip_branch_creation}} == true'

  # Skip if already on a feature-like branch (contains /)
  - action: variable.set
    params:
      name: should_create_branch
      value: false
    if: '{{current_branch}} != "main" && {{current_branch}} != "master" && {{current_branch}} != "develop"'

  # Use current branch name if not creating new one
  - action: variable.set
    params:
      name: branch_name
      value: "{{current_branch}}"
    if: '{{should_create_branch}} == false'

  - action: log.info
    params:
      message: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘              ğŸŒ¿ CREATING BRANCH                           â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Branch: {{branch_name}}
        Summary: {{change_summary}}
    if: '{{should_create_branch}} == true'

  - action: log.info
    params:
      message: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘              ğŸŒ¿ USING EXISTING BRANCH                     â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Already on branch: {{current_branch}}
        Skipping branch creation.
    if: '{{should_create_branch}} == false'

  - action: workflow.run
    description: Create new branch
    params:
      workflow: "git-create-branch"
      vars:
        branch_name: "{{branch_name}}"
    output: branch_result
    if: '{{should_create_branch}} == true'

  # ============================================================================
  # PHASE 3: COMMIT IN LOGICAL CHUNKS
  # ============================================================================
  
  - action: log.info
    params:
      message: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘              ğŸ“¦ CREATING SMART COMMITS                    â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Creating commits for each logical group of changes...

  # Note: This is a simplified version. In production, you'd loop through commit_groups
  # For now, we'll create one comprehensive commit
  
  - action: workflow.run
    description: Create smart commit
    params:
      workflow: "git-smart-commit"
      vars:
        files: "."
        commit_description: "{{change_summary}}"
    output: commit_result

  # ============================================================================
  # PHASE 4: PUSH TO REMOTE
  # ============================================================================
  
  - action: log.info
    params:
      message: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘              â¬†ï¸  PUSHING TO REMOTE                         â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  - action: workflow.run
    description: Push to remote
    params:
      workflow: "git-push"
      vars:
        remote: "origin"
        branch: "HEAD"
    output: push_result

  # ============================================================================
  # PHASE 5: CREATE PR/MR
  # ============================================================================
  
  - action: log.info
    params:
      message: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘              ğŸ¯ CREATING PR/MR                            â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Generate PR/MR details with AI
  - action: workflow.run
    description: Generate PR details
    params:
      workflow: "git-auto-pr"
      vars:
        provider: "{{provider}}"
        target_branch: "{{target_branch}}"
    output: pr_prep

  # Get current branch for PR creation
  - action: shell.execute_command
    description: Get current branch
    params:
      command: "git rev-parse --abbrev-ref HEAD"
    output: final_branch

  # Create GitHub PR using workflow
  - action: workflow.run
    description: Create GitHub Pull Request
    params:
      workflow: "github-create-pr"
      vars:
        owner: "{{github_owner}}"
        repo: "{{github_repo}}"
        head: "{{final_branch}}"
        base: "{{target_branch}}"
        title: "{{pr_prep.pr_title}}"
        body: "{{pr_prep.pr_description}}"
        draft: false
    output: github_pr_result
    if: '{{provider}} == "github"'

  # Create GitLab MR using workflow
  - action: workflow.run
    description: Create GitLab Merge Request
    params:
      workflow: "gitlab-create-mr"
      vars:
        project_id: "{{gitlab_project_id}}"
        source_branch: "{{final_branch}}"
        target_branch: "{{target_branch}}"
        title: "{{pr_prep.pr_title}}"
        description: "{{pr_prep.pr_description}}"
        remove_source_branch: true
    output: gitlab_mr_result
    if: '{{provider}} == "gitlab"'

  # ============================================================================
  # FINAL: SUCCESS MESSAGE
  # ============================================================================
  
  - action: log.info
    params:
      message: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘              âœ… AUTO-SHIP COMPLETE!                       â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸŒ¿ Branch: {{final_branch}}
        ğŸ“ Commits: Created with AI-generated messages
        â¬†ï¸  Pushed: Successfully pushed to origin
        ğŸ¯ PR/MR: Created with AI-generated description
        
        ğŸ”— View your PR:
        {{github_pr_result.pr_result.url}}
        
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if: '{{provider}} == "github"'

  - action: log.info
    params:
      message: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘              âœ… AUTO-SHIP COMPLETE!                       â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸŒ¿ Branch: {{final_branch}}
        ğŸ“ Commits: Created with AI-generated messages
        â¬†ï¸  Pushed: Successfully pushed to origin
        ğŸ¯ PR/MR: Created with AI-generated description
        
        ğŸ”— View your MR:
        {{gitlab_mr_result.mr_result.web_url}}
        
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if: '{{provider}} == "gitlab"'
